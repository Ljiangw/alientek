/*
 * Copyright (c) 2020 Teslabs Engineering S.L.
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;
#include <st/h7/stm32h743Xi.dtsi>
#include <st/h7/stm32h743iitx-pinctrl.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>

/ {
	model = "STMicroelectronics STM32H743ZI-NUCLEO board";
	compatible = "st,stm32h743zi-nucleo";

	chosen {
		zephyr,console = &usart1;
		zephyr,shell-uart = &usart1;
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		// zephyr,dtcm = &dtcm;
		// zephyr,code-partition = &slot0_partition;
		// zephyr,canbus = &fdcan1;
		zephyr,flash-controller = &w25q256;
	};

	leds: leds {
		compatible = "gpio-leds";

		green_led: led_0 {
			gpios = <&gpiob 0 GPIO_ACTIVE_LOW>;
			label = "User LD1";
		};

		beep: beeper {
			gpios = <&pcf8574 0 GPIO_ACTIVE_LOW>;
		};

	};

	pwmleds {
		compatible = "pwm-leds";

		red_pwm_led: red_pwm_led {
			pwms = <&pwm3 4 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		};

	};

	gpio-keys {
		compatible = "gpio-keys";
		polling-mode;

		d0: gpioc13 {
			gpios = <&gpioc 13 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
		};
	};

	custom-buttons {
		button_0: custom_button_0 {
			compatible = "custom,button";
			pin = <&d0>;
		};
	};

	/* 配置挂载点/lfs1 */
	// fstab {
	// 	compatible = "zephyr,fstab";
	// 	lfs1: lfs1 {
	// 		compatible = "zephyr,fstab,littlefs";
	// 		mount-point = "/lfs1";

	// 		/* 文件系统对应的flash partition*/
	// 		partition = <&lfs1_partition>;
	// 		automount;
	// 		no-format;
	// 		read-size = <16>;
	// 		prog-size = <16>;
	// 		cache-size = <64>;
	// 		lookahead-size = <32>;
	// 		block-cycles = <512>;
	// 	};
	// };

	aliases {
		led0 = &green_led;
		pwm-led0 = &red_pwm_led;
		button0 = &button_0;
		watchdog0 = &iwdg;
		die-temp0 = &die_temp;
		volt-sensor0 = &vref;
		volt-sensor1 = &vbat;
		beep0 = &beep;
	};
};

&clk_lsi {
	clock-frequency = <32768>; /* 32.768 kHz 晶振 */
	status = "okay";
};

&clk_hsi48 {
	status = "okay";
};

&clk_hse {
	clock-frequency = <DT_FREQ_M(25)>; 
	status = "okay";
};

&pll {
	div-m = <5>;
	mul-n = <160>;
	div-p = <2>; /* Fsys = clk_hse * (plln / (pllm * pllp)) = 400Mhz */
	div-q = <4>; 
	div-r = <2>;
	clocks = <&clk_hse>;
	status = "okay";
};

&pll2 {
	div-m = <5>;
	mul-n = <160>;
	div-p = <2>;
	div-q = <4>; /* gives 200MHz to the FDCAN; 25.07.17 jiangwei: need check */
	div-r = <2>;
	clocks = <&clk_hse>;
	status = "okay";
};

&rcc {
	clocks = <&pll>;
	clock-frequency = <DT_FREQ_M(400)>;
	d1cpre = <1>;
	hpre = <2>;
	d1ppre = <2>;
	d2ppre1 = <2>;
	d2ppre2 = <2>;
	d3ppre = <2>;
};

/* USART1：高速串口 */
&usart1 {
    pinctrl-0 = <&usart1_tx_pa9 &usart1_rx_pa10>;
	pinctrl-names = "default";
    current-speed = <115200>;
    status = "okay";
};

&usart3 {
	pinctrl-0 = <&usart3_tx_pd8 &usart3_rx_pd9>;
	pinctrl-names = "default";
	current-speed = <115200>;
	status = "okay";
};

zephyr_udc0: &usbotg_fs {
	pinctrl-0 = <&usb_otg_fs_dm_pa11 &usb_otg_fs_dp_pa12>;
	pinctrl-names = "default";
	status = "okay";
};

&rtc {
	clocks = <&rcc STM32_CLOCK_BUS_APB4 0x00010000>,
		 <&rcc STM32_SRC_LSI RTC_SEL(2)>;
	status = "okay";
};

&i2c1 {
	pinctrl-0 = <&i2c1_scl_pb8 &i2c1_sda_pb9>;
	pinctrl-names = "default";
	clock-frequency = <I2C_BITRATE_FAST>;
	status = "okay";
};

&i2c2 {
	pinctrl-0 = <&i2c2_scl_ph4 &i2c2_sda_ph5>;
	pinctrl-names = "default";
	status = "okay";
	clock-frequency = <I2C_BITRATE_FAST>;

	/* AP3216C Ambient Light and Proximity Sensor */
	ap3216c@1e {
		compatible = "liteon,ap3216c";
		reg = <0x1e>;
		status = "okay";
	};

	/* PCF8574T */
	pcf8574: pcf8574t@20 {
		compatible = "nxp,pcf857x";
		reg = <0x20>;
		gpio-controller;
		status = "okay";
		int-gpios = <&gpiob 12 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
        #gpio-cells = <2>;
        ngpios = <8>;            
	};
};

&timers3 {
	st,prescaler = <10000>;
	status = "okay";

	pwm3: pwm {
		status = "okay";
		pinctrl-0 = <&tim3_ch4_pb1>;
		pinctrl-names = "default";
	};
};

&adc1 {
	pinctrl-0 = <&adc1_inp15_pa3>;
	pinctrl-names = "default";
	st,adc-clock-source = "SYNC";
	st,adc-prescaler = <4>;
	status = "okay";
};

&die_temp {
	status = "okay";
};

&adc3 {
	pinctrl-0 = <&adc3_inp5_pf3>;
	pinctrl-names = "default";
	st,adc-clock-source = "SYNC";
	st,adc-prescaler = <4>;
	status = "okay";
};

&dac1 {
	status = "okay";
	pinctrl-0 = <&dac1_out1_pa4>;
	pinctrl-names = "default";
};

&rng {
	status = "okay";
};

&fdcan1 {
	pinctrl-0 = <&fdcan1_rx_pd0 &fdcan1_tx_pd1>;
	pinctrl-names = "default";
	clocks = <&rcc STM32_CLOCK_BUS_APB1_2 0x00000100>,
		 <&rcc STM32_SRC_PLL2_Q FDCAN_SEL(2)>;
	status = "okay";
};

/*
 * WARNING:
 * Possible pin conflicts:
 *          The pins PA2 and PB13 may conflict on selection of ETH_STM32_HAL,
 *          since they are used in ST Zio or ST morpho connectors.
 *          To avoid conflicting states the jumpers JP6 and JP7
 *          must be in ON state.
 */
&mac {
	status = "okay";
	pinctrl-0 = <&eth_rxd0_pc4
		     &eth_rxd1_pc5
		     &eth_ref_clk_pa1
		     &eth_crs_dv_pa7
		     &eth_tx_en_pg11
		     &eth_txd0_pg13
		     &eth_txd1_pb13>;
	pinctrl-names = "default";
	phy-connection-type = "rmii";
	phy-handle = <&eth_phy>;
};

&mdio {
	status = "okay";
	pinctrl-0 = <&eth_mdio_pa2 &eth_mdc_pc1>;
	pinctrl-names = "default";

	eth_phy: ethernet-phy@0 {
		compatible = "ethernet-phy";
		reg = <0x00>;
	};
};

&spi1 {
	status = "okay";
	pinctrl-0 = <&spi1_sck_pa5 &spi1_miso_pa6 &spi1_mosi_pb5>;
	pinctrl-names = "default";
	cs-gpios = <&gpiod 14 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
};

&quadspi {
	status = "okay";
	pinctrl-0 = <&quadspi_bk1_ncs_pb6
			 &quadspi_clk_pb2
		     &quadspi_bk1_io0_pf8
		     &quadspi_bk1_io1_pf9
		     &quadspi_bk1_io2_pf7
		     &quadspi_bk1_io3_pf6>;
	pinctrl-names = "default";

  	w25q256: qspi-nor-flash@0 {
		compatible = "st,stm32-qspi-nor";
		label = "W25Q256";
		reg = <0>; 
		size = <DT_SIZE_M(256)>; /* 256 Mbits */
		qspi-max-frequency = <80000000>;
		spi-bus-width = <4>;
		writeoc = "PP_1_4_4";
		status = "okay";

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			lfs1_partition: partition@0 {
				label = "storage";
				reg = <0x0 DT_SIZE_M(32)>;
			};
		};
	};
};

&backup_sram {
	status = "okay";
};

&flash0 {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		// lfs1_partition: partition@100000 {
		// 	label = "storage";
		// 	reg = <0x00100000 DT_SIZE_K(128)>;
		// };

		// /* 128KB for bootloader */
		// boot_partition: partition@0 {
		// 	label = "mcuboot";
		// 	reg = <0x00000000 DT_SIZE_K(128)>;
		// 	read-only;
		// };

		// /* storage: 128KB for settings */
		// storage_partition: partition@20000 {
		// 	label = "storage";
		// 	reg = <0x00020000 DT_SIZE_K(128)>;
		// };

		// /* application image slot: 256KB */
		// slot0_partition: partition@40000 {
		// 	label = "image-0";
		// 	reg = <0x00040000 DT_SIZE_K(256)>;
		// };

		// /* backup slot: 256KB */
		// slot1_partition: partition@80000 {
		// 	label = "image-1";
		// 	reg = <0x00080000 DT_SIZE_K(256)>;
		// };

		// /* swap slot: 128KB */
		// scratch_partition: partition@c0000 {
		// 	label = "image-scratch";
		// 	reg = <0x000c0000 DT_SIZE_K(128)>;
		// };
	};
};

&iwdg1 {
	status = "okay";
};

&vref {
	status = "okay";
};

&vbat {
	status = "okay";
};


